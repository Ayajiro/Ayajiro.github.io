(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{500:function(a,e,s){"use strict";s.r(e);var t=s(17),r=Object(t.a)({},(function(){var a=this,e=a._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("p",[a._v("跟著\n"),e("a",{attrs:{href:"https://youtu.be/Y9KNU2MnO-o?si=QjLI37bHBjRjoyhC",target:"_blank",rel:"noopener noreferrer"}},[a._v("All in One NextJS And NestJS Full Authentication Monorepo Project"),e("OutboundLink")],1),a._v(" 進行。")]),a._v(" "),e("p",[a._v("本節目標：")]),a._v(" "),e("ol",[e("li",[a._v("建立Monorepo專案")]),a._v(" "),e("li",[a._v("建立登入頁面")]),a._v(" "),e("li",[a._v("建立後端API")]),a._v(" "),e("li",[a._v("後端串接資料庫")]),a._v(" "),e("li",[a._v("簡單的資料格式驗證")]),a._v(" "),e("li",[a._v("由登入頁面送出資料給後端寫入資料庫")])]),a._v(" "),e("p",[a._v("參考資料補充於"),e("a",{attrs:{href:"2025-1-23-playforfun-note"}},[a._v("NextJS + NestJS Monorepo Note")])]),a._v(" "),e("h2",{attrs:{id:"建立-turborepo"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#建立-turborepo"}},[a._v("#")]),a._v(" 建立 Turborepo")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("npm i turbo -g\n")])])]),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("npx create-turbo@latest\n\nwhere would yoy like to create youre Turborepo?\n>> .\n")])])]),e("h2",{attrs:{id:"在apps下安裝nestjs工具"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#在apps下安裝nestjs工具"}},[a._v("#")]),a._v(" 在apps下安裝nestjs工具")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("cd apps\n\nnpm i -g @nestjs/cli\n\nnest new api\n\n")])])]),e("p",[a._v("這時執行 "),e("code",[a._v("npm run dev")]),a._v(" 跑起來的不是nestjs服務\n修改package.json指令")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('"start:dev": "nest start --watch"\n"dev": "nest start --watch",\n')])])]),e("p",[a._v("再次執行 "),e("code",[a._v("npm run dev")]),a._v(" 發現port已被使用\n調整nestjs監聽port\napi\\src\\main.ts\n如果port被佔用 需要清除該port")]),a._v(" "),e("h3",{attrs:{id:"安裝prisma"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安裝prisma"}},[a._v("#")]),a._v(" 安裝Prisma")]),a._v(" "),e("p",[a._v("這一段因為突然來了一個Neon DB，研究了一陣子，有些地方會跟教學不同。")]),a._v(" "),e("p",[a._v("在apps\\api下安裝")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("npm i prisma -D\n\nnpx prisma init\n")])])]),e("p",[a._v("連結Neon postgre資料庫\n在Neon申請帳號後，建立資料庫\n在apps\\api\\ .env檔案中，將DATABASE_URL改為Neon dashBoard connect產生的路徑")]),a._v(" "),e("h3",{attrs:{id:"拉取資料庫結構"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#拉取資料庫結構"}},[a._v("#")]),a._v(" 拉取資料庫結構")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("npx prisma db pull\n")])])]),e("p",[a._v("因為新建資料庫需要花比較多時間研究，這邊跟教學不同的地方是，使用教學Github上的檔案反向生成資料庫結構，但依然會需要先在Neon資料庫中建立一個Table，之後會蓋掉。")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("npx prisma db push\n")])])]),e("p",[a._v("這樣就可以確保資料庫格式和教學相同，減少需要除錯的地方。反過來也可以進入NeonTable看欄位的開法。所以其實可以先寫好schema再Push生成Table。實作上這樣開欄位應該比較合適。")]),a._v(" "),e("p",[a._v("接下來解析schema建立prisma-client")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("npx prisma generate\n")])])]),e("p",[a._v("nest 啟用 Prisma 服務")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("nest g s prisma\n")])])]),e("p",[a._v("現在可以在src資料夾下看到prisma服務檔案")]),a._v(" "),e("p",[a._v("從這裡取得prisma.service.ts的範例，覆蓋檔案\n"),e("a",{attrs:{href:"https://docs.nestjs.com/recipes/prisma",target:"_blank",rel:"noopener noreferrer"}},[a._v("Prisma | NestJS - A progressive Node.js framework"),e("OutboundLink")],1)]),a._v(" "),e("h3",{attrs:{id:"建立後端api"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#建立後端api"}},[a._v("#")]),a._v(" 建立後端API")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("nest g res auth --no-spec\n選REST API，不需要CRUD進入點\n")])])]),e("p",[a._v("這時會建立auth資料夾，以及controller、module、service等檔案。")]),a._v(" "),e("p",[a._v("在controller檔案中，建立Post指令signup，並呼叫registerUser函式。這時會需要建立dto(資料傳輸對象 data transfer object)。")]),a._v(" "),e("p",[a._v("在auth下手動建立dto資料夾，及creater-user.dto.ts檔案。\n安裝class資料驗證相關套件。")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("npm i -D class-validator class-transformer\n")])])]),e("p",[e("a",{attrs:{href:"https://ithelp.ithome.com.tw/articles/10340470",target:"_blank",rel:"noopener noreferrer"}},[a._v("【Day44】ChatGPT請教教我：NestJS！（三）- Controller & 資料驗證 ！class-validator & class-transformer！ - iT 邦幫忙::一起幫忙解決難題，拯救 IT 人的一天"),e("OutboundLink")],1)]),a._v(" "),e("p",[a._v("接著在main.ts中設定驗證流程。")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v(" app.useGlobalPipes(\n    new ValidationPipe({\n        transform:true,\n        whitelist:true,\n    })\n  );\n")])])]),e("p",[a._v("然後在authController及authService中建立註冊使用者方法registerUser()")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v(" %% controller %%\n registerUser(@Body() CreateUserDto: CreateUserDto) {\n    return this.authService.registerUser(CreateUserDto);\n  }\n  \n  %% service %%\n  registerUser(createUserDto: CreateUserDto) {\n\n        return 'This action adds a new user';\n\n    }\n")])])]),e("p",[a._v("接著再次使用nest res api，建立新的User class")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("nest g res user --no-spec\nREST API\ngenerate CRUD\n")])])]),e("p",[a._v("刪除User下的dto檔案，並將原本建立的create-user-dto移動過去。\n因為使用Prisma，entities資料夾也可刪除。\n將userService和userController中的createUserDto換成自己寫的，並且刪除其他方法。\n在userService中建立與Prisma的連結（引入prisma），建立函式透過prisma查詢User是否存在（prisma用來查詢的唯一欄位需要設定為@unique）。")]),a._v(" "),e("p",[a._v("需要hash使用者密碼，所以安裝hash工具 "),e("code",[a._v("npm i argon2")]),a._v(" 。照教學的說法這個套件速度比crypto快。")]),a._v(" "),e("p",[a._v("建立User的步驟：查詢是否存在>不存在建立User>Hash密碼之後給prisma處理")]),a._v(" "),e("p",[a._v("這一段的教學在async await部分很混亂，可以參考github檔案。")]),a._v(" "),e("h3",{attrs:{id:"前端部分"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前端部分"}},[a._v("#")]),a._v(" 前端部分")]),a._v(" "),e("p",[a._v("在web資料夾中建立app/auth/layout.tsx及auth/signup/page.tsx\n裡面的內容都是貼上的，這時在monorepo中執行npm run dev的話，建立起來的前端頁面會吃不到CSS，因為目前尚未安裝TailwindCss。")]),a._v(" "),e("p",[a._v("因為tailwind 4 才剛出不久，這邊安裝跟教學相同的3.4.17版本。\n"),e("a",{attrs:{href:"https://v3.tailwindcss.com/docs/guides/nextjs",target:"_blank",rel:"noopener noreferrer"}},[a._v("Install Tailwind CSS with Next.js - Tailwind CSS"),e("OutboundLink")],1)]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("安裝\nnpm install -D tailwindcss@3 postcss autoprefixer\n產生設定檔案\nnpx tailwindcss init -p\n")])])]),e("p",[a._v("將這段貼到tailwind.config檔案的content中")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('"./app/**/*.{js,ts,jsx,tsx,mdx}",\n"./pages/**/*.{js,ts,jsx,tsx,mdx}",\n"./components/**/*.{js,ts,jsx,tsx,mdx}",\n')])])]),e("p",[a._v("然後依官網教學覆蓋globals.css檔案")]),a._v(" "),e("p",[a._v("接下來要做登入表格，這邊要安裝 shad-cn "),e("a",{attrs:{href:"https://medium.com/@Kelly_CHI/shadcn-ui-tailwind-components-6fd4f1959147",target:"_blank",rel:"noopener noreferrer"}},[a._v("Shadcn-ui : 美觀、無障礙、又能 100 % 客製化的「元件合集」 | by Kelly CHI | Medium"),e("OutboundLink")],1),a._v("，")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("在根目錄執行\nnpx shadcn@canary init -c ./apps/web\n")])])]),e("p",[a._v("這時會跳錯表示tsconfig檔案沒有設定import alias")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('"baseUrl": ".",\n"paths": {\n  "@/*": ["./*"]\n}\n')])])]),e("p",[a._v("設定後存檔重跑\n![[Pasted image 20250202173108.png]]\n安裝成功")]),a._v(" "),e("p",[a._v("進到web資料夾安裝按鈕元件，元件檔案會出現在Component目錄之下。")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("npx shadcn@latest add button\nnpx shadcn@latest add label\nnpx shadcn@latest add input\n\n")])])]),e("p",[a._v("建立SignupForm元件。需要使用的表格元件都從Compnent中引用。")]),a._v(" "),e("p",[a._v("建立註冊按鈕，在Component下建立新的元件檔案。")]),a._v(" "),e("p",[a._v("接下來在web/lib 建立auth.ts和type.ts 做登入的資料驗證。\n安裝zod套件，這邊主要做幾件事：")]),a._v(" "),e("ol",[e("li",[a._v("每個資料格式的限制與提示訊息設定，使用Zod")]),a._v(" "),e("li",[a._v("串接後端註冊API")]),a._v(" "),e("li",[a._v("設定.env檔案（NextJS需要帶有NEXT前綴）\n成功打API後就會跳轉到404頁面，並且可以透過 npx prisma studio指令叫出資料庫後臺，檢查是否成功寫入資料庫。")])]),a._v(" "),e("p",[a._v("到這個階段，已經有註冊頁面可送出資料給後端寫入資料庫，並且包含簡易的資料驗證。")])])}),[],!1,null,null,null);e.default=r.exports}}]);